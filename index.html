<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BIR2316 Form Signing</title>
    <style>
        /* Styling for canvas and inputs */
        #pdfViewer {
            border: 1px solid #ccc;
            width: 100%;
            height: 800px;
            margin-bottom: 10px;
        }
        #signaturePad, #formInputs {
            margin-top: 20px;
        }
        .form-input {
            position: absolute;
            border: 1px solid #000;
            padding: 5px;
            background-color: #fff;
        }
        .date-picker, .text-box {
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>Fill and Sign BIR2316 Form</h1>
    
    <!-- PDF Viewer Canvas -->
    <canvas id="pdfViewer"></canvas>
    
    <!-- Text inputs and Date pickers -->
    <div id="formInputs">
        <input type="text" id="ctcNo" class="form-input text-box" placeholder="CTC/Valid ID No" style="top: 500px; left: 400px;">
        <input type="text" id="placeOfIssue" class="form-input text-box" placeholder="Place of Issue" style="top: 530px; left: 400px;">
        <input type="date" id="dateSigned" class="form-input date-picker" placeholder="Date Signed" style="top: 560px; left: 400px;">
        <input type="date" id="dateIssued" class="form-input date-picker" placeholder="Date Issued" style="top: 590px; left: 400px;">
    </div>

    <!-- SignaturePad for capturing signature -->
    <div id="signaturePad">
        <canvas id="signatureCanvas" width="300" height="100" style="border:1px solid #000;"></canvas>
        <button id="clearSignature">Clear Signature</button>
    </div>
    
    <!-- Download Button -->
    <button id="saveForm">Save Form with Signature</button>

    <!-- Include PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <!-- Include SignaturePad.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.0.0/signature_pad.umd.min.js"></script>

    <script>
        // Load PDF.js
        const pdfUrl = 'https://shyju-cv.github.io/testsignature/BIR2316.pdf'; // Replace with the actual path to BIR2316 file
        let pdfDoc = null, pageNum = 1, canvas = document.getElementById('pdfViewer'), ctx = canvas.getContext('2d');

        // Load the PDF document
        pdfjsLib.getDocument(pdfUrl).promise.then((pdf) => {
            pdfDoc = pdf;
            renderPage(pageNum);
        });

        function renderPage(num) {
            pdfDoc.getPage(num).then((page) => {
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext);
            });
        }

        // Initialize SignaturePad
        const signaturePadCanvas = document.getElementById('signatureCanvas');
        const signaturePad = new SignaturePad(signaturePadCanvas);

        document.getElementById('clearSignature').addEventListener('click', () => {
            signaturePad.clear();
        });

        document.getElementById('saveForm').addEventListener('click', async () => {
            if (!pdfDoc || signaturePad.isEmpty()) {
                alert("Please sign the form.");
                return;
            }

            // Draw the filled fields and signature on the PDF
            pdfDoc.getPage(pageNum).then((page) => {
                const viewport = page.getViewport({ scale: 1.5 });
                const textLayerCanvas = document.createElement('canvas');
                textLayerCanvas.width = canvas.width;
                textLayerCanvas.height = canvas.height;
                const textLayerCtx = textLayerCanvas.getContext('2d');

                // Draw filled fields onto the textLayerCanvas
                textLayerCtx.font = "16px Arial";
                textLayerCtx.fillText(document.getElementById('ctcNo').value, 400, 500);
                textLayerCtx.fillText(document.getElementById('placeOfIssue').value, 400, 530);
                textLayerCtx.fillText(document.getElementById('dateSigned').value, 400, 560);
                textLayerCtx.fillText(document.getElementById('dateIssued').value, 400, 590);

                // Draw the signature onto the textLayerCanvas
                const signatureImage = new Image();
                signatureImage.src = signaturePad.toDataURL();
                signatureImage.onload = () => {
                    textLayerCtx.drawImage(signatureImage, 350, 620, 150, 50); // Position signature
                    const pdfDataUrl = textLayerCanvas.toDataURL();

                    // Allow the user to download the filled PDF
                    const link = document.createElement('a');
                    link.href = pdfDataUrl;
                    link.download = 'BIR2316_Filled.pdf';
                    link.click();
                };
            });
        });
    </script>
</body>
</html>
